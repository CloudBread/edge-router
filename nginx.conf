worker_processes  5;  ## Default: 1
worker_rlimit_nofile 8192;

events {
  worker_connections  4096;  ## Default: 1024
}


http {
  log_format trace_request
  '{'
  '"trace_id": "$nginx_trace_id",'
  '"remote_addr": "$remote_addr",'
  '"time": "$time_iso8601",'
  '"request": "$request",'
  '"request_time": "$request_time",'
  '"request_method": "$request_method",'
  '"status": "$status"'
  '}';



  map $host $nginx_trace_id {
    default '';
  }

  map $host $frontend_span_id {
    default '';
  }

  server {
    listen 80;

    location / {
      proxy_pass      http://front-end:8079;
      

      set_by_lua_block $nginx_trace_id {
        if ngx.var.http_x_nginx_trace_id == nil then
          return io.open("/proc/sys/kernel/random/uuid"):read():gsub("%W","")
        else
          return ngx.var.http_x_nginx_trace_id
        end
      }

      set_by_lua_block $frontend_span_id {
        if ngx.var.http_x_frontend_span_id == nil then
          return io.open("/proc/sys/kernel/random/uuid"):read():gsub('%W','')
        else
          return ngx.var.http_x_frontend_span_id
        end
      }


      # Set zipkin request id
      proxy_set_header "X-B3-TraceId" $nginx_trace_id;
      proxy_set_header "X-B3-ParentSpanId" $nginx_trace_id;
      proxy_set_header "X-B3-SpanId" $frontend_span_id;
      proxy_set_header "X-B3-Sampled" 1;

      access_log /var/log/nginx/trace_request.pipe trace_request buffer=32k flush=1s;
    }
  }
}
